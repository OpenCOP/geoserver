<html>
  <wicket:head>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <style type="text/css">

.fake-button {
  background-color:#FCFCFC;
  border:1px solid #CCCCCC;
  cursor: pointer;
  padding: 2px 6px;
  color: #333333;
}
table {
  width: 0;
}
    </style>
    <script type="text/javascript">

var eoc = (function() {

  function removePipes(text) {
    return text.replace(/\|/g, "")
  }

  function iconSearch() {
    $('#icon-display-area').empty().text("Loading...")
    var queryStr = $('#icon-search-terms').val()
    $.getJSON(
      "/geoserver/wfs",
      { request: "GetFeature",
        version: "1.1.0",
        typeName: "opencop:iconmaster",
        outputFormat: "JSON",
        maxFeatures: 10,
        // startIndex: 10,
        CQL_FILTER: cqlStr(queryStr)},
      buildIconTable
    )
  }

  function cqlStr(queryStr) {
    return queryStr
      .split(" ")
      .map(function(n) { return " name like '%" + n + "%' " })
      .join("and")
  }

  function buildIconTable(json) {
    var props = $(json.features).map(function(i, n) { return n.properties })
    var table = $('<table>')
    props.each(function(i, n) {
      var img = $('<img>').attr('src', n.url)
      var name = $('<td>').text(n.name)
      var tr = $('<tr>')
        .append(img, name)
        .click(function() {selectIcon(img)})
      table.append(tr)
    })
    $('#icon-display-area').empty().append(table)
  }

  function selectIcon(img) {
    var src = img.attr('src')
    $('#iconname').val(src)
    $('#icon-preview').attr('src', src)
  }

  return {
    iconSearch: iconSearch,

    addField: function() {
      $('tr.field:last').clone().appendTo('table.fields')
      $('tr.field:last .name').val("")
      $('tr.field:last .name').focus()
    },

    deleteField: function(span) {
      if( $('tr.field').length > 1 ) {
        $(span).parents('tr.field').remove()
      }
    },

    changeStyleOption: function(input) {
      $("#use-existing-style-block")[input.checked ? "show" : "hide"]()
      $("#use-new-style-block")[!input.checked ? "show" : "hide"]()
    },

    onsubmit: function() {
      $("[name=serialized-fields]").val(
        $('tr.field')
          .map(function(i, tr) {
            return removePipes($(tr).find('input').val())
                 + "|"
                 + removePipes($(tr).find('select :selected').text())})
          .toArray().join("|"))
    }
  }
}())

$(function() {
  var textfield = $('input.text:first')
  if(textfield) textfield.focus().select()
  eoc.iconSearch()
})

    </script>
  </wicket:head>
  <body>
    <wicket:extend>
      <form wicket:id="featureTypeForm" onsubmit="return eoc.onsubmit()">

        <label for="layername">Layer Name</label>
        <input type="text" wicket:id="layername"></input>

        <label for="storesDropDown">Data Store</label>
        <select wicket:id="storesDropDown"></select>

        <h2>Style</h2>
        <label for="useExistingStyle">Use an Existing Style</label>
        <input type="checkbox" wicket:id="useExistingStyle"
               onclick="eoc.changeStyleOption(this)" />
        <!-- use an existing style -->
        <div id="use-existing-style-block" style="display:none">
          <ul>
            <li>
              <label for="defaultStyle"><wicket:message key="defaultStyle">Default Style</wicket:message></label>
              <select id="defaultStyle" class="select" wicket:id="defaultStyle"></select>
            </li>
            <li>
              <img wicket:id="defaultStyleLegendGraphic"></img>
            </li>
          </ul>
        </div>
        <!-- use a new style -->
        <div id="use-new-style-block" >
          <label for="icon-search-terms">Icon Search</label>
          <input type="text" id="icon-search-terms" onkeypress="eoc.iconSearch()" />
          <div id="icon-display-area">Loading icon images...</div>
          <label for="iconname">Icon Full Url</label>
          <img src="" id="icon-preview" />
          <input type="text" size="60" id="iconname" wicket:id="iconname"></input>
        </div>

        <input type="hidden" wicket:id="serialized-fields"></input>

        <h2>Schema</h2>
        <p style="margin:15px 0px 0px 0px">
          <span class="fake-button" onclick="eoc.addField()">+</span>
          Add field
        </p>
        <table class="fields">
          <tr wicket:id="schema" class="field">
            <td><span class="fake-button" onclick="eoc.deleteField(this)">-</span></td>
            <td><input type="text" wicket:id="name" class="name"></input></td>
            <td><select wicket:id="type" class="type"></select></td>
          </tr>
        </table>
        <input type="submit" value="Save Feature Type" />
      </form>
    </wicket:extend>
  </body>
</html>
